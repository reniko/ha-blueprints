# Home Assistant Blueprint â€“â€¯Ventilation Recommendation (per room)
# -----------------------------------------------------------------
# VERSION: 0.4.1Â Â (2025â€‘05â€‘21)
#
# Changelog 0.4.1
#   â€¢ Fixed blueprintâ€‘parser error (variables: comfort_max | int, min_temp_diff | float)
#   â€¢ Now quoting the !input filters correctly â†’ {{ (!input â€¦) | int }} / | float
#   â€¢ Small doc cleanup. Logic unchanged.â€‹
# -----------------------------------------------------------------
blueprint:
  name: Ventilation Recommendation (forecastâ€¯+â€¯time window,â€¯v0.4.1)
  description: |
    Calculates whether window ventilation is recommended for a single room
    using indoor / outdoor temperature, dewpoint, (optional) enthalpy and an
    optional forecast.â€¯The helper input_boolean <room>_ventilation stores the
    state; optional push messages go to a notify group.  
    Set *debug_log* to true to write a multiline explanation into the HA log.

  domain: automation
  source_url: https://github.com/reniko/ha-blueprints/blob/main/ventilation.yaml

  input:
    room_slug:
      name: Roomâ€‘Slug
      description: Short identifier without blanks (used to build entity ids)
    temp_in:
      name: Indoor temperature sensor
    temp_out:
      name: Outdoor temperature sensor
    dew_in:
      name: Indoor dewpoint sensor
    dew_out:
      name: Outdoor dewpoint sensor
    enthalpy_in:
      name: Indoor enthalpy sensor (optional)
      default: ""
    enthalpy_out:
      name: Outdoor enthalpy sensor (optional)
      default: ""
    # press sensors are optional â€“ only logged for info
    press_in:
      name: Indoor pressure sensor (optional)
      default: ""
    press_out:
      name: Outdoor pressure sensor (optional)
      default: ""
    forecast_high:
      name: Forecast high (e.g. next 12â€¯h max) (optional)
      default: ""
    forecast_low:
      name: Forecast low  (e.g. next 6â€¯h min) (optional)
      default: ""
    window_sensors:
      name: List of window contact sensors (optional)
      default: []
    heating_active:
      name: Boolean helper / climate attribute â€“Â on when heating
    recommendation_boolean:
      name: Helper (input_boolean) to store current recommendation state
    notify_group:
      name: notify.* group for push (optional)
      default: ""
    allow_night:
      name: Allow night ventilation
      selector:
        boolean:
    time_start:
      name: Earliest time for ventilation (HH:MM)
      default: "06:00"
    time_end:
      name: Latest time for ventilation (HH:MM)
      default: "22:00"
    comfort_max:
      name: Comfort max temp (Â°C)
      default: 25
    min_temp_diff:
      name: Minimum Î”T to ventilate (Â°C)
      default: 1
    debug_log:
      name: Write debug info to system_log
      selector:
        boolean:
      default: false

mode: single
max_exceeded: silent

trigger:
  # fires on relevant sensor changes or fallback every 5 min
  - platform: state
    entity_id: !input temp_in
  - platform: state
    entity_id: !input temp_out
  - platform: time_pattern
    minutes: "/5"

variables:
  temp_in: "{{ states(!input temp_in)|float }}"
  temp_out: "{{ states(!input temp_out)|float }}"
  dew_in: "{{ states(!input dew_in)|float }}"
  dew_out: "{{ states(!input dew_out)|float }}"
  enthalpy_in: "{{ states(!input enthalpy_in)|float(999) }}"
  enthalpy_out: "{{ states(!input enthalpy_out)|float(0) }}"
  press_in: "{{ states(!input press_in)|float }}"
  press_out: "{{ states(!input press_out)|float }}"
  f_high: "{{ states(!input forecast_high)|float(-99) }}"
  f_low: "{{ states(!input forecast_low)|float(99) }}"
  heating_on: "{{ is_state(!input heating_active, 'on') }}"
  allow_night: !input allow_night
  time_start: !input time_start
  time_end: !input time_end
  now_time: "{{ now().strftime('%H:%M') }}"
  comfort_max: "{{ (!input comfort_max) | int }}"
  min_tempdiff: "{{ (!input min_temp_diff) | float }}"

  # checks
  t_ok: "{{ temp_out < temp_in - min_tempdiff }}"
  d_ok: "{{ dew_out < dew_in }}"
  h_ok: "{{ enthalpy_out < enthalpy_in }}"
  forecast_ok: "{{ (f_low < comfort_max) and (f_high > temp_in) if f_low != 99 and f_high != -99 else true }}"
  timeframe_ok: "{{ allow_night or (time_start <= now_time < time_end) }}"
  should_vent: "{{ t_ok and d_ok and h_ok and forecast_ok and timeframe_ok and not heating_on }}"
  recommendation_current: "{{ states(!input recommendation_boolean) }}"
  debug_log: !input debug_log

action:
  - choose:
      - conditions: "{{ should_vent and recommendation_current == 'off' }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: !input recommendation_boolean
          - if:
              - "{{ debug_log }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: |
                    [Ventilation] {{ !input room_slug }} â†’ ON
                    T-OK {{ t_ok }} (out {{ temp_out }} < in {{ temp_in }} - Î” {{ min_tempdiff }})
                    D-OK {{ d_ok }} (out {{ dew_out }} < in {{ dew_in }})
                    H-OK {{ h_ok }} (out {{ enthalpy_out }} < in {{ enthalpy_in }})
                    F-OK {{ forecast_ok }} (low {{ f_low }} / high {{ f_high }})
          - if:
              - "{{ !input notify_group != '' }}"
              - condition: or
                conditions:
                  - "{{ !input window_sensors | length == 0 }}"
                  - condition: state
                    entity_id: !input window_sensors
                    match: any
                    state: 'off'
            then:
              - service: !input notify_group
                data:
                  message: "ðŸ’¨ LÃ¼ften im {{ !input room_slug }} empfohlen (Fenster sind geschlossen)."
      - conditions: "{{ not should_vent and recommendation_current == 'on' }}"
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: !input recommendation_boolean
          - if:
              - "{{ debug_log }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: |
                    [Ventilation] {{ !input room_slug }} â†’ OFF
                    T-OK {{ t_ok }} (out {{ temp_out }} < in {{ temp_in }} - Î” {{ min_tempdiff }})
                    D-OK {{ d_ok }} (out {{ dew_out }} < in {{ dew_in }})
                    H-OK {{ h_ok }} (out {{ enthalpy_out }} < in {{ enthalpy_in }})
                    F-OK {{ forecast_ok }} (low {{ f_low }} / high {{ f_high }})
          - if:
              - "{{ !input notify_group != '' }}"
              - condition: state
                entity_id: !input window_sensors
                match: any
                state: 'on'
            then:
              - service: !input notify_group
                data:
                  message: "ðŸªŸ Bitte Fenster im {{ !input room_slug }} schlieÃŸen."

# -----------------------------------------------------------------------------
# README (excerpt)
# ----------------
# â€¢ Leave press_* empty if you don't care. They no longer block ventilation.
# â€¢ Forecast sensors can be daily (temp/templow) or hourly (custom template).
# â€¢ Set debug_log: true for a detailed multiline entry on every evaluation.

blueprint:
  name: Climate Control
  description: >
    Control a climate entity based on inside and outside temperatures, prioritize PV energy usage,
    includes preemptive heating/cooling if PV is available and forecast suggests benefit.

    EVCC integration:
    Optionally use an evcc-controlled boolean (input_boolean/switch) to gate PV-based actions.
  domain: automation

  input:
    climate_entity:
      name: Climate Entity
      description: The climate entity to control.
      selector:
        entity:
          filter:
            - domain: climate

    inside_temperature_sensor:
      name: Inside Temperature Sensor (°C)
      description: The sensor that reports the inside temperature.
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: temperature

    outside_temperature_sensor:
      name: Outside Temperature Sensor (°C)
      description: The sensor that reports the outside temperature.
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: temperature

    weather_forecast_max_sensor:
      name: Weather Forecast Max Temperature Sensor (°C)
      description: >
        The sensor providing the forecasted max temperature.
        This is used to predict cold/hot weather.
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: temperature

    datetime_helper:
      name: datetime helper
      description: Helper sensor suspending next runtime of automation.
      selector:
        entity:
          filter:
            - domain: input_datetime

    pv_surplus_sensor:
      name: PV current available Surplus Sensor (W)
      description: Sensor showing current available PV energy surplus.
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: power

    pv_remaining_surplus_sensor:
      name: PV Remaining Surplus Sensor (kWh)
      description: Sensor showing remaining PV energy surplus for today.
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: energy

    pv_surplus_enable_boolean:
      name: EVCC PV surplus enable (input_boolean/switch) (optional)
      description: >
        If set, PV-based preemptive heating/cooling and forecast+PV actions are ONLY allowed when this entity is ON.

        Intended for evcc surplus control.

        IMPORTANT:
        When this entity is configured, these parameters are ignored:
        - minimum_pv_surplus_for_preemptive_heating
        - minimum_pv_surplus_for_preemptive_cooling

        The remaining surplus sensor (kWh) is still used as safety limit.

        If empty, the blueprint falls back to pv_surplus_sensor thresholds (legacy behavior).
      default: null
      selector:
        entity:
          filter:
            - domain: input_boolean
            - domain: switch
          multiple: false

    minimum_pv_surplus_for_preemptive_cooling:
      name: Minimum PV Surplus for Climate Control (W) Cooling
      description: >
        Minimum PV energy surplus needed for climate control to use excess energy for cooling.

        NOTE:
        Ignored if EVCC PV surplus enable is configured.
      default: 500
      selector:
        number:
          min: 100
          max: 5000
          unit_of_measurement: W

    minimum_pv_surplus_for_preemptive_heating:
      name: Minimum PV Surplus for Climate Control (W) Heating
      description: >
        Minimum PV energy surplus needed for climate control to use excess energy for heating.

        NOTE:
        Ignored if EVCC PV surplus enable is configured.
      default: 500
      selector:
        number:
          min: 100
          max: 5000
          unit_of_measurement: W

    heating_threshold:
      name: Heating Threshold (°C)
      description: The temperature below which heating or ventilation will be triggered.
      default: 10
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: "°C"

    preemptive_heating_threshold:
      name: Preemptive heating threshold (°C)
      description: The temperature below which preemptive heating could be triggered.
      default: 18
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: "°C"

    preemptive_heating_stop_threshold:
      name: Stop threshold for preemptive heating (°C)
      description: The temperature above which preemptive heating won't be triggered.
      default: 26
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: "°C"

    heating_temperature:
      name: temperature for heating (°C)
      description: Used as temperature for heating.
      default: 20
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: "°C"

    cooling_temperature:
      name: temperature for cooling (°C)
      description: Used as temperature for cooling.
      default: 26
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: "°C"

    preemptive_cooling_threshold:
      name: Preemptive cooling threshold (°C)
      description: The temperature above which preemptive cooling could be triggered.
      default: 28
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: "°C"

    preemptive_cooling_stop_threshold:
      name: Stop threshold for preemptive cooling (°C)
      description: The temperature below which preemptive cooling won't be triggered.
      default: 20
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: "°C"

    cooling_threshold:
      name: Cooling Threshold (°C)
      description: The temperature above which cooling or ventilation will be triggered.
      default: 30
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: "°C"

    change_frequency:
      name: Delay in minutes after an adjustment until a new adjustment is done
      description: Minutes will be added to the actual time. Next adjustment will be done after this amount of minutes.
      default: 15
      selector:
        number:
          min: 0
          max: 120
          unit_of_measurement: min

    ventilation_difference:
      name: temperature difference (outside, inside) for ventilation
      description: The temperature difference which must be between inside and outside temperature to start ventilation.
      default: 2
      selector:
        number:
          min: 0
          max: 10
          unit_of_measurement: K

mode: single

variables:
  climate_entity: !input climate_entity

  inside_temperature_sensor: !input inside_temperature_sensor
  outside_temperature_sensor: !input outside_temperature_sensor
  weather_forecast_max_sensor: !input weather_forecast_max_sensor

  pv_surplus_sensor: !input pv_surplus_sensor
  pv_remaining_surplus_sensor: !input pv_remaining_surplus_sensor
  pv_surplus_enable_boolean: !input pv_surplus_enable_boolean

  minimum_pv_surplus_for_preemptive_cooling: !input minimum_pv_surplus_for_preemptive_cooling
  minimum_pv_surplus_for_preemptive_heating: !input minimum_pv_surplus_for_preemptive_heating

  cooling_threshold: !input cooling_threshold
  preemptive_cooling_threshold: !input preemptive_cooling_threshold
  preemptive_cooling_stop_threshold: !input preemptive_cooling_stop_threshold
  cooling_temperature: !input cooling_temperature

  heating_temperature: !input heating_temperature
  preemptive_heating_threshold: !input preemptive_heating_threshold
  preemptive_heating_stop_threshold: !input preemptive_heating_stop_threshold
  heating_threshold: !input heating_threshold

  datetime_helper: !input datetime_helper
  change_frequency: !input change_frequency
  ventilation_difference: !input ventilation_difference

  inside_temp: "{{ states(inside_temperature_sensor) | float(18) }}"
  outside_temp: "{{ states(outside_temperature_sensor) | float(18) }}"
  forecast_max_temp: "{{ states(weather_forecast_max_sensor) | float(18) }}"

  pv_surplus_w: "{{ states(pv_surplus_sensor) | float(0) }}"
  pv_remaining_wh: "{{ (states(pv_remaining_surplus_sensor) | float(0)) * 1000 }}"
  pv_needed_wh_for_window_heat: "{{ (minimum_pv_surplus_for_preemptive_heating | float(0)) * (change_frequency | float(0)) / 60 }}"
  pv_needed_wh_for_window_cool: "{{ (minimum_pv_surplus_for_preemptive_cooling | float(0)) * (change_frequency | float(0)) / 60 }}"

  pv_enable_on: >-
    {% if pv_surplus_enable_boolean %}
      {{ is_state(pv_surplus_enable_boolean, 'on') }}
    {% else %}
      {{ none }}
    {% endif %}

  pv_ok_heat: >-
    {% if pv_surplus_enable_boolean %}
      {{ is_state(pv_surplus_enable_boolean, 'on') }}
    {% else %}
      {{ pv_surplus_w >= minimum_pv_surplus_for_preemptive_heating }}
    {% endif %}

  pv_ok_cool: >-
    {% if pv_surplus_enable_boolean %}
      {{ is_state(pv_surplus_enable_boolean, 'on') }}
    {% else %}
      {{ pv_surplus_w >= minimum_pv_surplus_for_preemptive_cooling }}
    {% endif %}

trigger:
  - platform: homeassistant
    event: start
  - platform: event
    event_type: automation_reloaded
  - platform: time
    at: !input datetime_helper

condition:
  - condition: time
    after: !input datetime_helper

action:
  - choose:
      # Condition 0: inside <= heating_threshold
      - conditions:
          - condition: template
            value_template: "{{ inside_temp <= heating_threshold }}"
        sequence:
          - choose:
              # Prefer ventilation if outside is warm enough
              - conditions:
                  - condition: template
                    value_template: "{{ outside_temp >= preemptive_heating_threshold }}"
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: !input climate_entity
                    data:
                      hvac_mode: fan_only
                  - service: logbook.log
                    data:
                      name: "Climate Control"
                      message: "Inside low ({{ inside_temp }}). Outside high ({{ outside_temp }}) -> fan_only."
                      entity_id: !input climate_entity
            default:
              - service: climate.set_temperature
                target:
                  entity_id: !input climate_entity
                data:
                  hvac_mode: heat
                  temperature: "{{ heating_temperature }}"
              - service: climate.set_fan_mode
                target:
                  entity_id: !input climate_entity
                data:
                  fan_mode: auto
              - service: logbook.log
                data:
                  name: "Climate Control"
                  message: "Inside low ({{ inside_temp }}) -> heat."
                  entity_id: !input climate_entity

      # Condition 1: inside >= cooling_threshold
      - conditions:
          - condition: template
            value_template: "{{ inside_temp >= cooling_threshold }}"
        sequence:
          - choose:
              # Prefer ventilation if outside is cool enough
              - conditions:
                  - condition: template
                    value_template: "{{ outside_temp <= preemptive_cooling_threshold }}"
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: !input climate_entity
                    data:
                      hvac_mode: fan_only
                  - service: logbook.log
                    data:
                      name: "Climate Control"
                      message: "Inside high ({{ inside_temp }}). Outside low ({{ outside_temp }}) -> fan_only."
                      entity_id: !input climate_entity
            default:
              - service: climate.set_temperature
                target:
                  entity_id: !input climate_entity
                data:
                  hvac_mode: cool
                  temperature: "{{ cooling_temperature }}"
              - service: climate.set_fan_mode
                target:
                  entity_id: !input climate_entity
                data:
                  fan_mode: auto
              - service: logbook.log
                data:
                  name: "Climate Control"
                  message: "Inside high ({{ inside_temp }}) -> cool."
                  entity_id: !input climate_entity

      # Condition 2: inside between thresholds
      - conditions:
          - condition: template
            value_template: "{{ inside_temp > heating_threshold and inside_temp < cooling_threshold }}"
        sequence:
          - choose:
              # Sub-condition: preemptive heating zone
              - conditions:
                  - condition: template
                    value_template: "{{ inside_temp < preemptive_heating_threshold }}"
                sequence:
                  - choose:
                      # Use ventilation if outside sufficiently warmer than inside
                      - conditions:
                          - condition: template
                            value_template: "{{ outside_temp > (inside_temp + ventilation_difference) }}"
                        sequence:
                          - service: climate.set_hvac_mode
                            target:
                              entity_id: !input climate_entity
                            data:
                              hvac_mode: fan_only
                          - service: logbook.log
                            data:
                              name: "Climate Control"
                              message: "Inside < preemptive heating. Outside warmer by diff -> fan_only."
                              entity_id: !input climate_entity

                      # PV-based heating (gated by evcc boolean if configured)
                      - conditions:
                          - condition: template
                            value_template: "{{ pv_ok_heat }}"
                          - condition: template
                            value_template: "{{ pv_remaining_wh > pv_needed_wh_for_window_heat }}"
                        sequence:
                          - service: climate.set_temperature
                            target:
                              entity_id: !input climate_entity
                            data:
                              hvac_mode: heat
                              temperature: "{{ heating_temperature }}"
                          - service: climate.set_fan_mode
                            target:
                              entity_id: !input climate_entity
                            data:
                              fan_mode: auto
                          - service: logbook.log
                            data:
                              name: "Climate Control"
                              message: "Preemptive heat: PV allowed (pv_ok_heat={{ pv_ok_heat }}, pv_enable={{ pv_enable_on }}) -> heat."
                              entity_id: !input climate_entity
                    default:
                      - service: climate.set_hvac_mode
                        target:
                          entity_id: !input climate_entity
                        data:
                          hvac_mode: "off"
                      - service: logbook.log
                        data:
                          name: "Climate Control"
                          message: "Inside < preemptive heating. No vent/PV -> off."
                          entity_id: !input climate_entity

              # Sub-condition: preemptive cooling zone
              - conditions:
                  - condition: template
                    value_template: "{{ inside_temp > preemptive_cooling_threshold }}"
                sequence:
                  - choose:
                      # Use ventilation if outside sufficiently cooler than inside
                      - conditions:
                          - condition: template
                            value_template: "{{ outside_temp < (inside_temp - ventilation_difference) }}"
                        sequence:
                          - service: climate.set_hvac_mode
                            target:
                              entity_id: !input climate_entity
                            data:
                              hvac_mode: fan_only
                          - service: logbook.log
                            data:
                              name: "Climate Control"
                              message: "Inside > preemptive cooling. Outside cooler by diff -> fan_only."
                              entity_id: !input climate_entity

                      # PV-based cooling (gated by evcc boolean if configured)
                      - conditions:
                          - condition: template
                            value_template: "{{ pv_ok_cool }}"
                          - condition: template
                            value_template: "{{ pv_remaining_wh > pv_needed_wh_for_window_cool }}"
                        sequence:
                          - service: climate.set_temperature
                            target:
                              entity_id: !input climate_entity
                            data:
                              hvac_mode: cool
                              temperature: "{{ cooling_temperature }}"
                          - service: climate.set_fan_mode
                            target:
                              entity_id: !input climate_entity
                            data:
                              fan_mode: auto
                          - service: logbook.log
                            data:
                              name: "Climate Control"
                              message: "Preemptive cool: PV allowed (pv_ok_cool={{ pv_ok_cool }}, pv_enable={{ pv_enable_on }}) -> cool."
                              entity_id: !input climate_entity
                    default:
                      - service: climate.set_hvac_mode
                        target:
                          entity_id: !input climate_entity
                        data:
                          hvac_mode: "off"
                      - service: logbook.log
                        data:
                          name: "Climate Control"
                          message: "Inside > preemptive cooling. No vent/PV -> off."
                          entity_id: !input climate_entity

              # Neutral zone: forecast + PV
              - conditions:
                  - condition: template
                    value_template: "{{ inside_temp >= preemptive_heating_threshold and inside_temp <= preemptive_cooling_threshold }}"
                sequence:
                  - choose:
                      # Forecast hot -> preemptive cooling if PV allows
                      - conditions:
                          - condition: template
                            value_template: "{{ forecast_max_temp >= preemptive_cooling_threshold }}"
                          - condition: template
                            value_template: "{{ pv_ok_cool }}"
                          - condition: template
                            value_template: "{{ pv_remaining_wh > pv_needed_wh_for_window_cool }}"
                          - condition: template
                            value_template: "{{ inside_temp > preemptive_cooling_stop_threshold }}"
                        sequence:
                          - service: climate.set_temperature
                            target:
                              entity_id: !input climate_entity
                            data:
                              hvac_mode: cool
                              temperature: "{{ cooling_temperature }}"
                          - service: climate.set_fan_mode
                            target:
                              entity_id: !input climate_entity
                            data:
                              fan_mode: auto
                          - service: logbook.log
                            data:
                              name: "Climate Control"
                              message: "Forecast hot + PV allowed -> cool."
                              entity_id: !input climate_entity

                      # Forecast cold -> preemptive heating if PV allows
                      - conditions:
                          - condition: template
                            value_template: "{{ forecast_max_temp <= preemptive_heating_threshold }}"
                          - condition: template
                            value_template: "{{ pv_ok_heat }}"
                          - condition: template
                            value_template: "{{ pv_remaining_wh > pv_needed_wh_for_window_heat }}"
                          - condition: template
                            value_template: "{{ inside_temp < preemptive_heating_stop_threshold }}"
                        sequence:
                          - service: climate.set_temperature
                            target:
                              entity_id: !input climate_entity
                            data:
                              hvac_mode: heat
                              temperature: "{{ heating_temperature }}"
                          - service: climate.set_fan_mode
                            target:
                              entity_id: !input climate_entity
                            data:
                              fan_mode: auto
                          - service: logbook.log
                            data:
                              name: "Climate Control"
                              message: "Forecast cold + PV allowed -> heat."
                              entity_id: !input climate_entity
                    default:
                      - service: climate.set_hvac_mode
                        target:
                          entity_id: !input climate_entity
                        data:
                          hvac_mode: "off"
                      - service: logbook.log
                        data:
                          name: "Climate Control"
                          message: "Neutral zone: no forecast/PV action -> off."
                          entity_id: !input climate_entity
    default:
      - service: climate.set_hvac_mode
        target:
          entity_id: !input climate_entity
        data:
          hvac_mode: "off"

  # Schedule next run
  - service: input_datetime.set_datetime
    target:
      entity_id: !input datetime_helper
    data:
      timestamp: "{{ now().timestamp() + (change_frequency | float(0) * 60) }}"
